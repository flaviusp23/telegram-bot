{% extends "base.html" %}

{% block content %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>Admin Dashboard</h1>
        <button class="btn btn-primary" onclick="loadDashboardData(true)" title="Refresh data">
            ðŸ”„ Refresh
        </button>
    </div>
    
    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h3>Total Users</h3>
            <p class="metric">-</p>
        </div>
        <div class="dashboard-card">
            <h3>Active Users (30d)</h3>
            <p class="metric">-</p>
        </div>
        <div class="dashboard-card">
            <h3>Total Responses</h3>
            <p class="metric">-</p>
        </div>
        <div class="dashboard-card">
            <h3>Distress Rate</h3>
            <p class="metric">-</p>
        </div>
    </div>
    
    <div class="dashboard-sections">
        <section class="dashboard-section">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                <button class="btn btn-secondary" onclick="viewUsers()">View Users</button>
                <button class="btn btn-secondary" onclick="viewLogs()">View Logs</button>
            </div>
        </section>
        
        <section class="dashboard-section">
            <h2>Recent Activity</h2>
            <div id="activity-log">
                <p>Loading activity log...</p>
            </div>
        </section>
        
        <section class="dashboard-section">
            <h2>Response Statistics</h2>
            <div id="response-stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Avg Severity (30d):</span>
                        <span class="stat-value" id="avg-severity">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Response Rate:</span>
                        <span class="stat-value" id="response-rate">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">User Growth:</span>
                        <span class="stat-value" id="user-growth">-</span>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.stat-item {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.stat-label {
    color: #666;
    font-size: 14px;
}

.stat-value {
    font-size: 20px;
    font-weight: bold;
    color: #333;
}

.dashboard-card .metric {
    font-size: 36px;
    font-weight: bold;
    margin: 10px 0;
    color: #2196F3;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function createUpdateIndicator() {
    const indicator = document.createElement('div');
    indicator.id = 'update-indicator';
    indicator.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #4CAF50; color: white; padding: 8px 16px; border-radius: 4px; opacity: 0.5; transition: opacity 0.3s;';
    document.body.appendChild(indicator);
    return indicator;
}

async function loadDashboardData(fresh = false) {
    try {
        // Use the apiRequest function from main.js which includes auth headers
        // Add fresh=true to bypass cache for real-time updates
        const endpoint = fresh ? '/analytics/dashboard?fresh=true' : '/analytics/dashboard';
        const data = await window.erasmusAdmin.apiRequest(endpoint);
        
        // Update dashboard metrics
        if (data.overview) {
            document.querySelector('.dashboard-card:nth-child(1) .metric').textContent = data.overview.total_users;
            document.querySelector('.dashboard-card:nth-child(2) .metric').textContent = data.overview.active_users;
            document.querySelector('.dashboard-card:nth-child(3) .metric').textContent = data.overview.total_responses;
            document.querySelector('.dashboard-card:nth-child(4) .metric').textContent = data.metrics.distress_percentage.toFixed(1) + '%';
        }
        
        // Update additional statistics
        if (data.metrics) {
            document.getElementById('avg-severity').textContent = data.metrics.average_severity.toFixed(1) + '/5';
            document.getElementById('response-rate').textContent = data.metrics.response_rate.toFixed(1) + '%';
            document.getElementById('user-growth').textContent = data.metrics.user_growth_rate > 0 ? '+' + data.metrics.user_growth_rate.toFixed(1) + '%' : data.metrics.user_growth_rate.toFixed(1) + '%';
        }
        console.log('Dashboard data loaded:', data);
        
        // Show update indicator
        const updateTime = new Date().toLocaleTimeString();
        const indicator = document.getElementById('update-indicator') || createUpdateIndicator();
        indicator.textContent = `Last updated: ${updateTime}`;
        indicator.style.opacity = '1';
        setTimeout(() => indicator.style.opacity = '0.5', 1000);
    } catch (error) {
        console.error('Failed to load dashboard data:', error);
    }
}

function exportData() {
    window.location.href = '/api/v1/export';
}

function viewUsers() {
    window.location.href = '/users';
}

function viewLogs() {
    window.location.href = '/logs';
}

// Load dashboard data on page load and refresh every 30 seconds
document.addEventListener('DOMContentLoaded', () => {
    loadDashboardData(); // Initial load (can use cache)
    // Refresh every 30 seconds with fresh data
    setInterval(() => loadDashboardData(true), 30000);
});
</script>
{% endblock %}