{% extends "base.html" %}

{% block extra_css %}
<style>
    .user-header {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }
    
    .user-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .info-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .info-label {
        font-size: 14px;
        color: #666;
        font-weight: 500;
    }
    
    .info-value {
        font-size: 16px;
        color: #333;
    }
    
    .responses-section {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .filters-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-group label {
        font-size: 14px;
        color: #666;
    }
    
    .filter-group select,
    .filter-group input {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .responses-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .responses-table th {
        background-color: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #dee2e6;
    }
    
    .responses-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
    }
    
    .responses-table tr:hover {
        background-color: #f8f9fa;
    }
    
    .response-value {
        font-weight: 500;
    }
    
    .response-yes {
        color: #dc3545;
    }
    
    .response-no {
        color: #28a745;
    }
    
    .severity-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
    }
    
    .severity-1 { background: #d4edda; color: #155724; }
    .severity-2 { background: #cce5ff; color: #004085; }
    .severity-3 { background: #fff3cd; color: #856404; }
    .severity-4 { background: #f8d7da; color: #721c24; }
    .severity-5 { background: #f5c6cb; color: #721c24; }
    
    .back-button {
        margin-bottom: 20px;
    }
    
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #2196F3;
    }
    
    .stat-label {
        color: #666;
        margin-top: 5px;
    }
    
    /* Mobile user detail page */
    @media (max-width: 768px) {
        .user-header {
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .user-header h1 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .user-info {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .info-label {
            font-size: 12px;
        }
        
        .info-value {
            font-size: 14px;
        }
        
        .stats-cards {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            padding: 15px;
        }
        
        .stat-value {
            font-size: 24px;
        }
        
        .stat-label {
            font-size: 12px;
        }
        
        .responses-section {
            padding: 20px;
        }
        
        .responses-section h2 {
            font-size: 1.3rem;
        }
        
        .filters-bar {
            flex-direction: column;
            gap: 10px;
            padding: 15px;
        }
        
        .filter-group {
            flex-direction: column;
            align-items: stretch;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
        }
        
        .responses-table {
            font-size: 0.9rem;
            overflow-x: auto;
            display: block;
            white-space: nowrap;
        }
        
        .responses-table thead,
        .responses-table tbody,
        .responses-table tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        
        .responses-table {
            width: 100%;
            min-width: 500px;
        }
        
        .responses-table th,
        .responses-table td {
            padding: 8px;
            font-size: 0.8rem;
        }
        
        .back-button {
            margin-bottom: 15px;
            width: 100%;
        }
        
        .severity-badge {
            font-size: 12px;
            padding: 3px 8px;
        }
    }
    
    @media (max-width: 480px) {
        .user-header {
            padding: 15px;
        }
        
        .user-header h1 {
            font-size: 1.25rem;
        }
        
        .user-info {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .stats-cards {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .stat-card {
            padding: 10px;
        }
        
        .stat-value {
            font-size: 20px;
        }
        
        .responses-section {
            padding: 15px;
        }
        
        .responses-table {
            min-width: 450px;
        }
        
        /* Hide notes column on very small screens */
        .responses-table th:nth-child(4),
        .responses-table td:nth-child(4) {
            display: none;
        }
        
        .filters-bar {
            padding: 10px;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px;
            font-size: 14px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <button class="btn btn-secondary back-button" onclick="window.location.href='/users'">
        ‚Üê Back to Users
    </button>
    
    <div class="user-header">
        <h1 id="user-name">Loading...</h1>
        <div class="user-info" id="user-info">
            <!-- User info will be populated here -->
        </div>
    </div>
    
    <div class="stats-cards" id="stats-cards">
        <!-- Stats will be populated here -->
    </div>
    
    <div class="responses-section">
        <h2>Questionnaire Responses</h2>
        
        <div class="filters-bar">
            <div class="filter-group">
                <label>Type:</label>
                <select id="filter-type" onchange="filterResponses()">
                    <option value="">All Types</option>
                    <option value="distress_check">Distress Check</option>
                    <option value="severity_rating">Severity Rating</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Date Range:</label>
                <select id="filter-range" onchange="filterResponses()">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                </select>
            </div>
            
            <div class="filter-group">
                <button class="btn btn-primary" onclick="exportUserResponses()">
                    üì• Export Responses
                </button>
            </div>
        </div>
        
        <table class="responses-table">
            <thead>
                <tr>
                    <th>Date & Time</th>
                    <th>Question Type</th>
                    <th>Response</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody id="responses-tbody">
                <tr>
                    <td colspan="4" style="text-align: center; padding: 40px;">
                        Loading responses...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let userId = null;
let allResponses = [];
let userData = null;

// Get user ID from URL
const urlParams = new URLSearchParams(window.location.search);
userId = urlParams.get('id');

if (!userId) {
    alert('No user ID provided');
    window.location.href = '/users';
}

async function loadUserData() {
    try {
        // Load user details
        const userResponse = await window.erasmusAdmin.apiRequest(`/users/${userId}`);
        userData = userResponse;
        
        // Update header
        document.getElementById('user-name').textContent = 
            `${userData.first_name} ${userData.family_name || ''}`;
        
        // Update user info
        document.getElementById('user-info').innerHTML = `
            <div class="info-item">
                <span class="info-label">User ID</span>
                <span class="info-value">${userData.id}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Telegram ID</span>
                <span class="info-value">${userData.telegram_id}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Status</span>
                <span class="info-value status-${userData.status}">${userData.status}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Registration Date</span>
                <span class="info-value">${window.erasmusAdmin.formatDate(userData.registration_date)}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Last Interaction</span>
                <span class="info-value">${userData.last_interaction ? window.erasmusAdmin.formatDate(userData.last_interaction) : 'Never'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Total Responses</span>
                <span class="info-value">${userData.response_count}</span>
            </div>
        `;
        
        // Load responses
        const responsesData = await window.erasmusAdmin.apiRequest(`/users/${userId}/responses?limit=1000`);
        allResponses = responsesData;
        
        // Calculate stats
        calculateStats();
        
        // Display responses
        displayResponses(allResponses);
        
    } catch (error) {
        console.error('Failed to load user data:', error);
        alert('Failed to load user data');
        window.location.href = '/users';
    }
}

function calculateStats() {
    const distressResponses = allResponses.filter(r => r.question_type === 'distress_check');
    const severityResponses = allResponses.filter(r => r.question_type === 'severity_rating');
    
    const distressYes = distressResponses.filter(r => r.response_value === 'yes').length;
    const distressRate = distressResponses.length > 0 ? 
        ((distressYes / distressResponses.length) * 100).toFixed(1) : 0;
    
    const avgSeverity = severityResponses.length > 0 ?
        (severityResponses.reduce((sum, r) => sum + parseInt(r.response_value), 0) / severityResponses.length).toFixed(1) : 0;
    
    // Get responses from last 7 days
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const recentResponses = allResponses.filter(r => new Date(r.response_timestamp) >= weekAgo);
    
    document.getElementById('stats-cards').innerHTML = `
        <div class="stat-card">
            <div class="stat-value">${allResponses.length}</div>
            <div class="stat-label">Total Responses</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${distressRate}%</div>
            <div class="stat-label">Distress Rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${avgSeverity}/5</div>
            <div class="stat-label">Avg Severity</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${recentResponses.length}</div>
            <div class="stat-label">Responses (7d)</div>
        </div>
    `;
}

function displayResponses(responses) {
    const tbody = document.getElementById('responses-tbody');
    
    if (responses.length > 0) {
        tbody.innerHTML = responses.map(response => {
            let responseDisplay = '';
            
            if (response.question_type === 'distress_check') {
                responseDisplay = `<span class="response-value response-${response.response_value}">${response.response_value.toUpperCase()}</span>`;
            } else if (response.question_type === 'severity_rating') {
                responseDisplay = `<span class="severity-badge severity-${response.response_value}">${response.response_value}/5</span>`;
            } else {
                responseDisplay = response.response_value;
            }
            
            return `
                <tr>
                    <td>${window.erasmusAdmin.formatDate(response.response_timestamp)}</td>
                    <td>${formatQuestionType(response.question_type)}</td>
                    <td>${responseDisplay}</td>
                    <td>-</td>
                </tr>
            `;
        }).join('');
    } else {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No responses found</td></tr>';
    }
}

function formatQuestionType(type) {
    return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function filterResponses() {
    const typeFilter = document.getElementById('filter-type').value;
    const rangeFilter = document.getElementById('filter-range').value;
    
    let filtered = [...allResponses];
    
    // Filter by type
    if (typeFilter) {
        filtered = filtered.filter(r => r.question_type === typeFilter);
    }
    
    // Filter by date range
    const now = new Date();
    let startDate;
    
    switch (rangeFilter) {
        case 'today':
            startDate = new Date(now.setHours(0, 0, 0, 0));
            break;
        case 'week':
            startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            break;
        case 'month':
            startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            break;
        default:
            startDate = null;
    }
    
    if (startDate) {
        filtered = filtered.filter(r => new Date(r.response_timestamp) >= startDate);
    }
    
    displayResponses(filtered);
}

async function exportUserResponses() {
    try {
        const format = confirm('Export as Excel? (OK for Excel, Cancel for CSV)') ? 'excel' : 'csv';
        const token = localStorage.getItem('access_token');
        
        const response = await fetch(`/api/v1/export/responses?format=${format}&days=365&user_id=${userId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `user_${userId}_responses_${new Date().toISOString().split('T')[0]}.${format === 'excel' ? 'xlsx' : 'csv'}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        } else {
            alert('Failed to export responses');
        }
    } catch (error) {
        console.error('Export failed:', error);
        alert('Export failed');
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', loadUserData);
</script>
{% endblock %}